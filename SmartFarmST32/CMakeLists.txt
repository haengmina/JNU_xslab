#######################################
# Generated By CMake Generator v1.2.7 #
#######################################

#if want toolchain setting
if(NOT DEFINED CMAKE_TOOLCHAIN_FILE)
    set(CMAKE_TOOLCHAIN_FILE "${CMAKE_CURRENT_LIST_DIR}/toolchain/arm-none-eabi-gcc.cmake")
endif()
#or
#cmake -DCMAKE_TOOLCHAIN_FILE="" ..

set(CMAKE_EXPORT_COMPILE_COMMANDS True CACHE INTERNAL "")

cmake_minimum_required(VERSION 3.19)
project(SmartFarmST32
    VERSION 1.1.8
    DESCRIPTION "센서 노드 및 제어 노드 MCU Software"
    HOMEPAGE_URL "https://git.xslab.co.kr/xslab/daeeun/smartfarmst32"
)

# specify the C/C++ standard
enable_language(C CXX ASM)
if(NOT DEFINED CMAKE_CXX_STANDARD_REQUIRED)
    set(CMAKE_CXX_STANDARD 17)
    set(CMAKE_CXX_STANDARD_REQUIRED True)
endif()
if(NOT DEFINED CMAKE_C_STANDARD_REQUIRED)
    set(CMAKE_C_STANDARD 17)
    set(CMAKE_C_STANDARD_REQUIRED True)
endif()

if("${CMAKE_BUILD_TYPE}" STREQUAL "")
    set(CMAKE_BUILD_TYPE "RelWithDebInfo")
endif()

set(SDK_MSP_IT_DISABLE True)
set(CPU_OPTION -mcpu=cortex-m0plus -mfloat-abi=soft)
add_compile_options(${CPU_OPTION})
add_link_options(${CPU_OPTION})

set(compile_options
    #add an option to all of language
    $<$<BOOL:${SIZE_OPTIMIZE_ENABLE}>:-DSIZE_OPTIMIZE_ENABLE>
    -Wall
    -ftree-vectorize
    -fopt-info-vec-all=auto_vectorize_info.txt
    -DSTM32G0B1xx
    $<$<BOOL:${STDOUT_TO_UART_ENABLE}>:-DSTDOUT_TO_UART_ENABLE>
    $<$<BOOL:${STATUS_TEST_LOOP_ENABLE}>:-DSTATUS_TEST_LOOP_ENABLE>

    #add an option to specific build type
    $<$<CONFIG:Release>:$<IF:$<BOOL:${SIZE_OPTIMIZE_ENABLE}>,-Os,-O2>>

    $<$<CONFIG:RelWithDebInfo>:$<IF:$<BOOL:${SIZE_OPTIMIZE_ENABLE}>,-Os,-O2>>
    $<$<CONFIG:RelWithDebInfo>:-gdwarf-4>

    $<$<CONFIG:Debug>:$<IF:$<BOOL:${SIZE_OPTIMIZE_ENABLE}>,-Os,-Og>>
    $<$<CONFIG:Debug>:-gdwarf-4>
    $<$<CONFIG:Debug>:-DDEBUG>

    #add an option to specific language
    #$<$<COMPILE_LANGUAGE:C>:-DC_DEF>
    #$<$<COMPILE_LANGUAGE:CXX>:-DCXX_DEF>
)

set(link_options
    # -TSTM32G0B1VETx_FLASH.ld
    -Tcustom_STM32G0B1VETx_FLASH.ld
)

set(link_directory_list
    "${CMAKE_CURRENT_LIST_DIR}/lib/${CMAKE_SYSTEM_PROCESSOR}"
    "${CMAKE_CURRENT_LIST_DIR}/extra/ldscripts"
)

set(header_directory_list
    "${CMAKE_CURRENT_LIST_DIR}/include"
)

set(source_directory_list
    "${CMAKE_CURRENT_LIST_DIR}/src"
)

set(source_exclude_pattern
    ""
)

set(docs_exclude_pattern
if(DOCS_PROTOCOL_ONLY)
    "${CMAKE_CURRENT_LIST_DIR}/HOWTOBUILD.md"
    "${CMAKE_CURRENT_LIST_DIR}/src"
    "${CMAKE_CURRENT_LIST_DIR}/include/board_io.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/checksum.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/control_interface_board.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/firmware_manager.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/system_config.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/gps_parser.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/mxc6655.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/protocol.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/onboard_packet_handler.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/packet_manager.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/sensor_interface_board.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/stm32g0xx_hal_conf.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/stm32g0xx_it.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/tla2528.h"
    "${CMAKE_CURRENT_LIST_DIR}/include/util.h"
    "${CMAKE_CURRENT_LIST_DIR}/lib"
endif()
)

option(DOCS_AUTO_BUILD_DISABLE "Disable Document Auto Generate When Release or RelWithDebInfo Mode" True)
option(DOCS_INSTALL_DISABLE "Disable Document Install" True)
option(STDOUT_TO_UART_ENABLE "stdout to UART1 Enable" False)
option(STATUS_TEST_LOOP_ENABLE "Status Test Loop Enable" False)
option(DOCS_PROTOCOL_ONLY "Docs Target is Only Protocol" False)

set(CPACK_DEBIAN_PACKAGE_MAINTAINER "KJW")
set(CPACK_DEBIAN_PACKAGE_DEPENDS "systemd")
set(CPACK_RPM_PACKAGE_REQUIRES "systemd")

include(${CMAKE_CURRENT_LIST_DIR}/Common.cmake)

add_executable(SmartFarmST32 ${source_file_list})
target_link_directories(SmartFarmST32 PUBLIC ${link_directory_list})
target_include_directories(SmartFarmST32 PUBLIC ${header_directory_list})
target_compile_options(SmartFarmST32 PUBLIC ${compile_options})
target_link_options(SmartFarmST32 PUBLIC ${link_options})
target_compile_options(SmartFarmST32 PRIVATE
    -DVERSION="v${PROJECT_VERSION}"
    -DVERSION_MAJOR=${PROJECT_VERSION_MAJOR}
    -DVERSION_MINOR=${PROJECT_VERSION_MINOR}
    -DVERSION_PATCH=${PROJECT_VERSION_PATCH}
    -DCOMMIT_HASH="${COMMIT_HASH}"
)

include_directories(${header_directory_list}) #for subproject
add_compile_options(${compile_options}) #for subproject
add_link_options(${link_options}) #for subproject

install(TARGETS SmartFarmST32 DESTINATION bin)

target_link_options(SmartFarmST32 PRIVATE -Wl,-demangle,-Map,$<TARGET_FILE:SmartFarmST32>.map)
add_custom_target(SmartFarmST32_LIST ALL DEPENDS SmartFarmST32 COMMENT "Generate $<TARGET_FILE:SmartFarmST32>.lst"
    COMMAND ${CMAKE_OBJDUMP} -SC $<TARGET_FILE:SmartFarmST32> > $<TARGET_FILE:SmartFarmST32>.lst
)

#if want include subproject
add_subdirectory(${CMAKE_CURRENT_LIST_DIR}/lib/stm32g0-hal)
add_subdirectory(${CMAKE_CURRENT_LIST_DIR}/lib/segger-rtt)

target_link_libraries(SmartFarmST32 stm32g0-hal)
if(NOT STDOUT_TO_UART_ENABLE)
    target_link_libraries(SmartFarmST32 segger_rtt)
endif()

#if want cmake modules based library link
#find_package(Threads REQUIRED)
#target_link_libraries(SmartFarmST32 pthread)

#if want pkg-config based library link
#find_package(PkgConfig REQUIRED)
#pkg_check_modules(LIBPNG REQUIRED IMPORTED_TARGET libpng)
#target_link_libraries(SmartFarmST32 PkgConfig::LIBPNG)

